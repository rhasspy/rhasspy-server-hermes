{% extends "layout.html" %}

<!-- Home page for testing Rhasspy services -->

{% block body %}

<!-- siteId -->
<h3 class="text-center" title="Hermes Site Id" x-text="getSiteId()"></h3>

<!-- Services Bar -->
<div id="services" class="btn-group text-center w-100">

    <a href="/settings#mqtt" class="btn flex-fill p-2" 
	   x-bind:title="'MQTT: ' + (profile.mqtt.enabled ? 'external' : 'internal')" 
	   x-bind:class="{ 'btn-dark': !profile.mqtt.enabled, 'btn-success' : profile.mqtt.enabled }"
	>
	    <i class="fas fa-inverse fa-network-wired fa-lg"></i>
    </a>

    <a href="/settings#microphone" class="btn flex-fill p-2" 
	   x-bind:title="'Audio input: ' + profile.microphone.system" 
	   x-bind:class="{ 'btn-dark': profile.microphone.system === 'dummy', 'btn-success': profile.microphone.system !== 'dummy' }"
	>
      <i class="fas fa-inverse fa-microphone fa-lg"></i>
    </a>

	<a href="/settings#handle" class="btn flex-fill p-2" 
	   x-bind:title="'Intent handling: ' + profile.handle.system" 
	   x-bind:class="{ 'btn-dark': profile.handle.system === 'dummy', 'btn-success': profile.handle.system !== 'dummy'}"
	>
		<i class="fas fa-inverse fa-home fa-lg"></i>
	</a>

	<a href="/settings#wake" class="btn flex-fill p-2"
	   x-bind:title="'Wake word: ' + profile.wake.system" 
	   x-bind:class="{ 'btn-dark': profile.wake.system === 'dummy', 'btn-success': profile.wake.system !== 'dummy' }"
	>
		<i class="fas fa-inverse fa-exclamation-circle fa-lg"></i>
	</a>

	<a href="/settings#speech" class="btn flex-fill p-2"
	   x-bind:title="'Speech to text: ' + profile.speech_to_text.system" 
	   x-bind:class="{ 'btn-dark': profile.speech_to_text.system === 'dummy', 'btn-success': profile.speech_to_text.system !== 'dummy' }"
	>
		<i class="fas fa-inverse fa-phone-volume fa-lg"></i>
	</a>

	<a href="/settings#intent" class="btn flex-fill p-2"
	   x-bind:title="'Intent recognition: ' + profile.intent.system" 
	   x-bind:class="{ 'btn-dark': profile.intent.system === 'dummy', 'btn-success': profile.intent.system !== 'dummy' }"
	>
		<i class="fas fa-inverse fa-comment fa-lg"></i>
	</a>

	<a href="/settings#tts" class="btn flex-fill p-2"
	   x-bind:title="'Text to speech: ' + profile.text_to_speech.system" 
	   x-bind:class="{ 'btn-dark': profile.text_to_speech.system === 'dummy', 'btn-success': profile.text_to_speech.system !== 'dummy' }"
	>
		<i class="fas fa-inverse fa-paper-plane fa-lg"></i>
	</a>

	<a href="/settings#sounds" class="btn flex-fill p-2"
	   x-bind:title="'Audio output: ' + profile.sounds.system" 
	   x-bind:class="{ 'btn-dark': profile.sounds.system === 'dummy', 'btn-success': profile.sounds.system !== 'dummy' }"
	>
		<i class="fas fa-inverse fa-volume-up fa-lg"></i>
	</a>

	<a href="/settings#dialogue" class="btn flex-fill p-2"
	   x-bind:title="'Dialogue management: ' + profile.dialogue.system" 
	   x-bind:class="{ 'btn-dark': profile.dialogue.system === 'dummy', 'btn-success': profile.dialogue.system !== 'dummy' }"
	>
		<i class="fas fa-inverse fa-tasks fa-lg"></i>
	</a>
</div>
<!-- End Services Bar -->

<!-- Microphone/STT Testing -->
<div class="card-group">
    <div class="card test-card">
        <div class="card-body">
            <div class="container">
                <div class="row">
                    <div class="col">
                        <button id="wakeup" class="btn btn-warning" onclick="wakeUp()" title="Wake up Rhasspy and listen for a voice command">
                            <i class="fas fa-2x fa-exclamation-circle"></i>
                        </button>
                        <span>Wake Up</span>
                    </div>
                    <div class="col">
                        <button id="play-command" onclick="playCommand()" class="btn btn-success" title="Play the last recorded voice command">
                            <i class="fas fa-2x fa-play"></i>
                        </button>
                        <span>Play Recording</span>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-xs-auto">
                        <input title="Show audio energy" type="checkbox" id="audio-summary" onclick="toggleAudioSummary()" class="form-control">
                    </div>
                    <div class="col">
                        <div title="Debiased audio energy" class="progress position-relative" style="height: 1rem;">
                            <div id="progress-audio" class="progress-bar w-0" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="1000">
                                <small class="justify-content-center d-flex position-absolute w-100">Audio Energy</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-xs-auto">
                        <i id="audio-websocket" class="fas fa-circle text-success" style="display: none; vertical-align:top;" title="Connected to audio summary websocket"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-footer">
            Microphone
        </div>
    </div>
    <div class="card test-card">
        <div class="card-body">
            <input id="wav-file" type="file" onchange="uploadWAV()" hidden>
            <button id="upload" onclick="chooseWAV()" class="btn btn-info" title="Upload WAV voice command and recognize it">
                <i class="fas fa-2x fa-upload"></i>
            </button>
            <span>Upload WAV File</span>
        </div>
        <div class="card-footer">
            Speech to Text
        </div>
    </div>
</div>
<!-- End Microphone/STT Testing -->

<!-- Intent Recognition Testing -->
<div class="card mt-3">
    <div class="card-body">
        <form onsubmit="recognize()">
            <div class="input-group">
                <button type="submit" id="intent-recognize" title="Recognize an intent from text" class="btn btn-primary">
                    <i class="fas fa-inverse fa-comment"></i>
                    Recognize
                </button>
                <input type="text" id="intent-text" class="form-control ml-1" placeholder="Text to recognize">
                <i id="intent-websocket" class="fas fa-circle text-success ml-2 pt-2" style="display: none;" title="Connected to intent websocket"></i>
            </div>
            <div class="input-group">
                <input type="checkbox" class="mr-2" id="handle-intent">
                <label for="handle-intent" class="col-form-label">Handle Intent</label>
            </div>
            <div id="intent-error" class="alert alert-danger mt-3 mb-0" style="display: none;">
                No intent recognized
            </div>
            <div id="intent-summary" style="display:none;" class="form-group mt-3 mb-0">
                <div class="form-row">
                    <div id="intent-name" title="Intent name" class="badge badge-danger"></div>
                </div>
                <div class="form-row">
                    <ul id="intent-slots" title="Intent slots" class="mt-1"></ul>
                </div>
                <div class="form-row">
                    <button type="button" title="Show intent JSON" onclick="$('#intentJSONModal').modal('show')" class="btn btn-secondary">Show JSON</button>
                </div>
            </div>
        </form>
    </div>
    <div class="card-footer">
        Intent Recognition
    </div>
</div>
<!-- End Intent Recognition Testing -->

<!-- Intent JSON Modal -->
<div id="intentJSONModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="intentJSONModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="intentJSONModalLabel">Intent JSON</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <textarea id="intent-json" type="text" class="form-control" rows="15"></textarea>
            </div>
        </div>
    </div>
</div>
<!-- End Intent JSON Modal -->

<!-- Text to Speech Testing -->
<div class="card mt-3">
    <div class="card-body">
        <form onsubmit="speak()">
            <div class="input-group">
                <button type="submit" id="tts-speak" title="Speak a sentence using text to speech" class="btn btn-primary">
                    <i class="fas fa-inverse fa-paper-plane"></i>
                    Speak
                </button>
                <input type="text" id="tts-text" class="form-control ml-1" placeholder="Text to speak">
            </div>
        </form>
    </div>
    <div class="card-footer">
        Text to Speech
    </div>
</div>
<!-- End Text to Speech Testing -->

{% endblock %}

{% block script %}
<script type="text/javascript">

 function getSiteId() {
     var siteIdStr = rhasspy.profile.mqtt.site_id || 'default';
     return siteIdStr.split(',')[0]
 }

 // Show intent and slots in web UI
 function setIntent(response) {
     $('#intent-error').hide()
     $('#intent-summary').hide()
     $('#intent-slots li').remove()

     $('#intent-json').val(JSON.stringify(response, null, 4));
     $('#intent-text').val(response.raw_text || response.text);

     if (response.intent.name.length == 0) {
         $('#intent-error').show()
         return;
     }

     $('#intent-summary').show()
     $('#intent-name').text(response.intent.name)
     for (slotName in response.slots) {
         $('#intent-slots').append(
             '<li>' +
             '<span>' + response.slots[slotName] + '</span>' +
             '<span class="badge badge-primary ml-1">' + slotName + '</span>' +
             '</li>'
         );
     }
 }

 // Wake Rhasspy up, listen for a voice command, then recognize the intent.
 function wakeUp() {
     $('#wakeup').prop('disabled', true);
     rhasspy.postBusy('Listening for command', '/api/listen-for-command')
            .always(function() {
                $('#wakeup').prop('disabled', false);
            })
            .done(function(response) {
                $('#intent-text').val(response['raw_text']);
                setIntent(response);
            });
 }

 // POST to /api/play-recording to play last recorded voice command
 function playCommand() {
     $('#play-command').prop('disabled', true);
     rhasspy.postBusy('Playing last command', '/api/play-recording')
            .always(function() {
                $('#play-command').prop('disabled', false);
            });
 }

 // Click hidden file input for WAV upload
 function chooseWAV() {
     event.preventDefault();
     $('#wav-file').click();
     return false;
 }

 // Read WAV file into a buffer and POST to /api/speech-to-intent
 function uploadWAV() {
     var file = event.target.files[0];

     var reader = new FileReader();
     reader.onload = function() {
         var wavData = this.result;
         rhasspy.postBusy('Transcribing WAV',
                          '/api/speech-to-intent',
                          wavData, true, 'audio/wav')
                .done(function(response) {
                    setIntent(response);
                });
     }

     reader.readAsArrayBuffer(file);
 }

 // POST text to /api/text-to-intent and display intent
 function recognize() {
     event.preventDefault();

     var text = $('#intent-text').val();
     if (text.length > 0) {
         $('#intent-recognize').prop('disabled', true);
         params = '?nohass=true'
         if ($('#handle-intent').prop('checked')) {
             params = ''
         }

         rhasspy.postBusy('Recognizing intent', '/api/text-to-intent' + params, text)
                .always(function() {
                    $('#intent-recognize').prop('disabled', false);
                })
                .done(function(response) {
                    setIntent(response);
                });
     } else {
         alert('No text to recognize')
     }

     return false;
 }

 // POST text to /api/text-to-speech to speak sentence
 function speak() {
     event.preventDefault();

     var text = $('#tts-text').val();
     if (text.length > 0) {
         $('#tts-speak').prop('disabled', true);
         rhasspy.postBusy(text, '/api/text-to-speech', text)
                .always(function() {
                    $('#tts-speak').prop('disabled', false);
                });
     } else {
         alert('No text to speak')
     }

     return false;
 }

 // Enable or disable audio summaries
 function toggleAudioSummary() {
     if ($('#audio-summary').prop('checked')) {
         $.post('/api/audio-summaries', 'on');

     } else {
         $.post('/api/audio-summaries', 'off');
     }

     $('#progress-audio').width('0%');
 }


 $(document).ready(() => {
     rhasspy.makeWebSocket(
         '/api/events/intent',
         (socket) => {
             $('#intent-websocket').show();

             socket.onmessage = (e) => {
                 setIntent(JSON.parse(e.data));
             }
         });

     rhasspy.makeWebSocket(
         '/api/events/audiosummary',
         (socket) => {
             $('#audio-websocket').show();

             socket.onmessage = (e) => {
                 var summary = JSON.parse(e.data);
                 var progressPercent = summary.debiased_energy / 10;
                 var progressId = "#progress-audio";
                 $(progressId).width(progressPercent + '%');

                 if (summary.is_speech) {
                     $(progressId).addClass('bg-success');
                 } else {
                     $(progressId).removeClass('bg-success');
                 }
             }
         });
 })

</script>
{% endblock %}
